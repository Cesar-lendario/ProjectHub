<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Meta tags para prevenir cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>TaskMeet: Gerenciamento Profissional de Projetos</title>
    <script>
      // Sistema de versionamento e limpeza autom√°tica de cache
      window.CACHE_VERSION = '2025.12.04.v2';
      console.log('[Cache] üîß Vers√£o:', window.CACHE_VERSION);
      
      // CR√çTICO: Limpar storage corrompido automaticamente
      (function cleanupStorage() {
        try {
          var storedVersion = localStorage.getItem('app_cache_version');
          console.log('[Cache] üì¶ Vers√£o armazenada:', storedVersion);
          
          // Se a vers√£o mudou OU n√£o existe, limpar TUDO
          if (storedVersion !== window.CACHE_VERSION) {
            console.warn('[Cache] ‚ö†Ô∏è Vers√£o mudou de', storedVersion, 'para', window.CACHE_VERSION);
            console.warn('[Cache] üßπ Limpando storage antigo...');
            
            // Guardar informa√ß√µes essenciais que n√£o devem ser perdidas
            var preserveKeys = [];
            
            // Limpar localStorage (exceto keys preservadas)
            Object.keys(localStorage).forEach(function(key) {
              if (preserveKeys.indexOf(key) === -1) {
                console.log('[Cache] üóëÔ∏è Removendo:', key);
                localStorage.removeItem(key);
              }
            });
            
            // Limpar sessionStorage
            sessionStorage.clear();
            
            // Limpar cache API se dispon√≠vel
            if ('caches' in window) {
              caches.keys().then(function(names) {
                names.forEach(function(name) {
                  console.log('[Cache] üóëÔ∏è Removendo cache:', name);
                  caches.delete(name);
                });
              });
            }
            
            // Limpar IndexedDB do Supabase (causa comum de problemas)
            if ('indexedDB' in window) {
              try {
                // Supabase usa esses bancos
                var dbsToDelete = ['supabase-auth', 'supabase-realtime'];
                dbsToDelete.forEach(function(dbName) {
                  var request = indexedDB.deleteDatabase(dbName);
                  request.onsuccess = function() {
                    console.log('[Cache] üóëÔ∏è IndexedDB removido:', dbName);
                  };
                });
              } catch (e) {
                console.warn('[Cache] ‚ö†Ô∏è Erro ao limpar IndexedDB:', e);
              }
            }
            
            // Salvar nova vers√£o
            localStorage.setItem('app_cache_version', window.CACHE_VERSION);
            console.log('[Cache] ‚úÖ Storage limpo e vers√£o atualizada');
            
            // Se n√£o estiver em processo de reload, recarregar uma vez
            if (!sessionStorage.getItem('version_reload_done')) {
              sessionStorage.setItem('version_reload_done', 'true');
              console.log('[Cache] üîÑ Recarregando p√°gina ap√≥s limpeza...');
              setTimeout(function() {
                window.location.reload(true);
              }, 100);
              return;
            }
          } else {
            console.log('[Cache] ‚úÖ Vers√£o atual, storage OK');
          }
          
          // Limpar flag de reload ap√≥s sucesso
          if (sessionStorage.getItem('version_reload_done')) {
            sessionStorage.removeItem('version_reload_done');
          }
        } catch (error) {
          console.error('[Cache] ‚ùå Erro ao limpar storage:', error);
        }
      })();
      
      // Detectar problemas de carregamento e for√ßar reload
      var loadingStartTime = Date.now();
      var loadingCheckInterval = setInterval(function() {
        var elapsed = Date.now() - loadingStartTime;
        // Se demorar mais de 15 segundos para carregar, algo est√° errado
        if (elapsed > 15000) {
          console.warn('[Cache] ‚ö†Ô∏è Carregamento demorou mais de 15s...');
          clearInterval(loadingCheckInterval);
          
          // Verificar se j√° tentou recarregar recentemente
          var lastReload = sessionStorage.getItem('last_emergency_reload');
          var now = Date.now();
          
          // S√≥ recarregar se n√£o recarregou nos √∫ltimos 30 segundos
          if (!lastReload || (now - parseInt(lastReload)) > 30000) {
            console.warn('[Cache] üîÑ For√ßando reload de emerg√™ncia...');
            sessionStorage.setItem('last_emergency_reload', now.toString());
            
            // Limpar tudo antes de recarregar
            try {
              localStorage.removeItem('taskmeet-auth-token');
              sessionStorage.clear();
            } catch (e) {
              console.error('[Cache] ‚ùå Erro ao limpar antes de reload:', e);
            }
            
            window.location.reload(true);
          } else {
            console.error('[Cache] ‚ùå J√° tentou recarregar recentemente. Problema persistente!');
            // Mostrar mensagem de erro para o usu√°rio
            var root = document.getElementById('root');
            if (root && !root.hasChildNodes()) {
              root.innerHTML = '<div style="padding: 40px; text-align: center; font-family: system-ui;">' +
                '<h2 style="color: #dc2626;">‚ö†Ô∏è Erro ao Carregar Aplica√ß√£o</h2>' +
                '<p style="color: #64748b; margin: 20px 0;">A aplica√ß√£o est√° demorando muito para carregar.</p>' +
                '<button onclick="localStorage.clear(); sessionStorage.clear(); window.location.reload(true);" ' +
                'style="background: #4f46e5; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">' +
                'üîÑ Limpar Cache e Recarregar' +
                '</button>' +
                '<p style="color: #94a3b8; font-size: 14px; margin-top: 20px;">Pressione o bot√£o acima ou Ctrl+Shift+R</p>' +
                '</div>';
            }
          }
        }
      }, 5000);
      
      // Limpar timers quando carregar com sucesso
      window.addEventListener('load', function() {
        clearInterval(loadingCheckInterval);
        sessionStorage.removeItem('last_emergency_reload');
        console.log('[Cache] ‚úÖ P√°gina carregada com sucesso em ' + (Date.now() - loadingStartTime) + 'ms');
      });
      
      // Detectar erros de carregamento de m√≥dulos
      window.addEventListener('error', function(event) {
        var errorMsg = event.message || '';
        var errorSrc = event.filename || '';
        
        // Se for erro de m√≥dulo ou fetch, pode ser cache corrompido
        if (errorMsg.includes('Failed to fetch') || 
            errorMsg.includes('Loading chunk') ||
            errorMsg.includes('Importing a module script failed')) {
          console.error('[Cache] ‚ùå Erro de carregamento de m√≥dulo:', errorMsg);
          
          // Limpar cache e recarregar
          if (!sessionStorage.getItem('module_error_reload')) {
            sessionStorage.setItem('module_error_reload', 'true');
            console.warn('[Cache] üîÑ Limpando cache ap√≥s erro de m√≥dulo...');
            localStorage.clear();
            setTimeout(function() {
              window.location.reload(true);
            }, 100);
          }
        }
      }, true);
    </script>
</head>
  <body>
    <div id="root"></div>
    <script type="module" src="./index.tsx"></script>
  </body>
</html>